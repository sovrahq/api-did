{"version":3,"file":"sovra.cjs.production.min.js","sources":["../src/SovraLedger.ts"],"sourcesContent":["/*\n * Sovra Ledger - DID anchoring for ethrex network by LambdaClass\n *\n * This ledger extends EthereumLedger with:\n * - Sovra-specific branding and logging\n * - Chunked event fetching for scalability\n * - Explorer URL integration for transaction tracking\n *\n * Network: ethrex (https://github.com/lambdaclass/ethrex)\n * DID Method: did:quarkid:sovra\n */\n\nimport {\n  EthereumLedgerUtils as ethereumLedgerUtils,\n  EthereumLedger,\n  ElementEventData,\n  EthereumFilter\n} from '@quarkid-sidetree/ethereum';\n\nimport {\n  BlockchainTimeModel,\n  TransactionModel,\n  ServiceVersionModel\n} from '@quarkid-sidetree/common';\n\nimport Web3 from 'web3';\n\nconst { version } = require('../package.json');\n\n// Sovra network configuration\nconst SOVRA_CONFIG = {\n  testnet: {\n    explorer: 'https://explorer.testnet.sovra.io',\n    rpc: 'https://rpc.testnet.sovra.io'\n  },\n  mainnet: {\n    explorer: 'https://explorer.sovra.io', // TBD\n    rpc: 'https://rpc.sovra.io' // TBD\n  }\n};\n\nexport default class SovraLedger extends EthereumLedger {\n  // Branding prefix for all Sovra logs\n  private readonly SOVRA_PREFIX = '[Sovra]';\n\n  // Chunked fetching state (following RSKLedger pattern)\n  protected lastSyncedBlockchainTime: number = 0;\n  protected startingTime: number = 0;\n\n  // Default to testnet explorer\n  private explorerBaseUrl: string = SOVRA_CONFIG.testnet.explorer;\n\n  constructor(\n    web3: Web3,\n    protected eventPullChunkSize: number,\n    public contractAddress?: string,\n    startingBlockchainTime?: number,\n    logger?: Console\n  ) {\n    super(web3, contractAddress, logger);\n\n    if (startingBlockchainTime) {\n      this.startingTime = startingBlockchainTime;\n    }\n  }\n\n  /**\n   * Returns service version identifying this as 'sovra' ledger\n   */\n  getServiceVersion(): Promise<ServiceVersionModel> {\n    return Promise.resolve({\n      name: 'sovra',\n      version,\n    });\n  }\n\n  /**\n   * Initialize the ledger with Sovra-specific logging\n   */\n  public async initialize(): Promise<void> {\n    this.logger.log(`${this.SOVRA_PREFIX} Initializing Sovra Ledger (ethrex by LambdaClass)...`);\n\n    if (this.contractAddress) {\n      this.logger.log(`${this.SOVRA_PREFIX} Anchor contract: ${this.contractAddress}`);\n    }\n\n    // Call parent initialization (sets up account, networkId, contract)\n    await super.initialize();\n\n    // If no starting time was provided and contract was just deployed, use current block\n    if (!this.contractAddress) {\n      this.startingTime = (await this.getLatestTime()).time;\n    }\n\n    // Log connection details\n    this.logger.log(`${this.SOVRA_PREFIX} Connected to Sovra network`);\n    this.logger.log(`${this.SOVRA_PREFIX}   Network ID: ${this.networkId}`);\n    this.logger.log(`${this.SOVRA_PREFIX}   Account: ${this.from}`);\n    this.logger.log(`${this.SOVRA_PREFIX}   Explorer: ${this.explorerBaseUrl}`);\n    this.logger.log(`${this.SOVRA_PREFIX} Ledger ready for DID operations`);\n  }\n\n  /**\n   * Helper to check if a value is a number\n   */\n  private isNumber(n: any): boolean {\n    return !isNaN(parseFloat(n)) && !isNaN(n - 0);\n  }\n\n  /**\n   * Fetch transactions with chunked event fetching for better performance\n   * Following RSKLedger pattern for scalability\n   */\n  public _getTransactions = async (\n    fromBlock: number | string,\n    toBlock: number | string,\n    options?: { filter?: EthereumFilter; omitTimestamp?: boolean }\n  ): Promise<TransactionModel[]> => {\n    const contract = await this.getAnchorContract();\n\n    // Resolve block numbers if strings like 'latest' are provided\n    let from: number;\n    if (this.isNumber(fromBlock)) {\n      from = fromBlock as number;\n    } else {\n      from = (await ethereumLedgerUtils.getBlock(this.web3, fromBlock)).number;\n    }\n\n    let to: number;\n    if (this.isNumber(toBlock)) {\n      to = toBlock as number;\n    } else {\n      to = (await ethereumLedgerUtils.getBlock(this.web3, toBlock)).number;\n    }\n\n    // Use the most recent synced position to avoid re-fetching\n    const effectiveFrom = Math.max(from, this.lastSyncedBlockchainTime);\n\n    this.logger.log(`${this.SOVRA_PREFIX} Fetching events from block ${effectiveFrom} to ${to}...`);\n\n    // Chunked fetching prevents memory issues with large block ranges\n    const { events, lastSynced } = await ethereumLedgerUtils.getPastEventsChunked(\n      contract,\n      'Anchor',\n      effectiveFrom,\n      to,\n      this.eventPullChunkSize,\n      options?.filter\n    );\n\n    this.logger.log(`${this.SOVRA_PREFIX} Fetched ${events.length} anchor event(s)`);\n\n    // Update last synced position\n    if (lastSynced > this.lastSyncedBlockchainTime) {\n      this.lastSyncedBlockchainTime = lastSynced;\n    }\n\n    // Convert events to Sidetree transaction format\n    const txns = events.map((log) =>\n      ethereumLedgerUtils.eventLogToSidetreeTransaction(log as ElementEventData)\n    );\n\n    if (options?.omitTimestamp) {\n      return txns;\n    }\n\n    return ethereumLedgerUtils.extendSidetreeTransactionWithTimestamp(this.web3, txns);\n  };\n\n  /**\n   * Helper to get transactions since a specific transaction number\n   */\n  private async _getTransactionsSince(\n    fromBlock: number | string,\n    toBlock: number | string,\n    since: number,\n    options?: { filter?: EthereumFilter; omitTimestamp?: boolean }\n  ): Promise<TransactionModel[]> {\n    const transactions = await this._getTransactions(fromBlock, toBlock, options);\n    return transactions.filter(x => x.transactionNumber > since);\n  }\n\n  /**\n   * Read transactions with optimized chunked fetching\n   */\n  public async read(\n    sinceTransactionNumber?: number,\n    transactionTimeHash?: string\n  ): Promise<{ moreTransactions: boolean; transactions: TransactionModel[] }> {\n    const options = { omitTimestamp: true };\n    let transactions: TransactionModel[];\n\n    if (sinceTransactionNumber !== undefined) {\n      // Path 1: Get transactions since a specific transaction number\n      transactions = await this._getTransactionsSince(\n        this.startingTime,\n        'latest',\n        sinceTransactionNumber,\n        options\n      );\n    } else if (transactionTimeHash) {\n      // Path 2: Get transactions from a specific block\n      const block = await ethereumLedgerUtils.getBlock(this.web3, transactionTimeHash);\n      if (block?.number) {\n        transactions = await this._getTransactions(block.number, block.number, options);\n      } else {\n        transactions = [];\n      }\n    } else {\n      // Path 3: Get all transactions from starting block\n      transactions = await this._getTransactions(this.startingTime, 'latest', options);\n    }\n\n    return {\n      moreTransactions: false,\n      transactions,\n    };\n  }\n\n  /**\n   * Write anchor to Sovra blockchain with branded logging\n   */\n  public write = async (anchorString: string, _fee = 0): Promise<void> => {\n    this.logger.log(`${this.SOVRA_PREFIX} Preparing to anchor batch to Sovra blockchain...`);\n\n    const contract = await this.getAnchorContract();\n    const { numberOfOperations, buffer } = this.getWriteData(anchorString);\n\n    this.logger.log(`${this.SOVRA_PREFIX} Batch contains ${numberOfOperations} DID operation(s)`);\n\n    try {\n      const methodCall = contract.methods.anchorHash(\n        '0x' + buffer.toString('hex').substring(4),\n        numberOfOperations\n      );\n\n      // Estimate gas and get current gas price\n      const currentGasPrice = await this.web3.eth.getGasPrice();\n      const gas = await methodCall.estimateGas();\n      const gasPrice = Math.round(parseInt(currentGasPrice) * 1).toString();\n\n      this.logger.log(`${this.SOVRA_PREFIX} Sending transaction (gas: ${gas}, gasPrice: ${gasPrice})...`);\n\n      const txn = await methodCall.send({\n        from: this.from,\n        gas,\n        gasPrice\n      });\n\n      // Log success with explorer link\n      const txUrl = `${this.explorerBaseUrl}/tx/${txn.transactionHash}`;\n      this.logger.info(`${this.SOVRA_PREFIX} Batch anchored successfully!`);\n      this.logger.info(`${this.SOVRA_PREFIX}   Transaction: ${txn.transactionHash}`);\n      this.logger.info(`${this.SOVRA_PREFIX}   Explorer: ${txUrl}`);\n      this.logger.info(`${this.SOVRA_PREFIX}   Operations: ${numberOfOperations}`);\n\n    } catch (err) {\n      const error = err as Error;\n      this.logger.error(`${this.SOVRA_PREFIX} Transaction failed: ${error.message}`);\n      throw err;\n    }\n  };\n\n  /**\n   * Get approximate blockchain time from cache\n   */\n  public get approximateTime(): BlockchainTimeModel {\n    return this.cachedBlockchainTime;\n  }\n\n  /**\n   * Set explorer URL (useful for switching between testnet/mainnet)\n   */\n  public setExplorerUrl(url: string): void {\n    this.explorerBaseUrl = url;\n    this.logger.log(`${this.SOVRA_PREFIX} Explorer URL updated to: ${url}`);\n  }\n}\n"],"names":["version","require","SovraLedger","_EthereumLedger","web3","eventPullChunkSize","contractAddress","startingBlockchainTime","logger","_this","call","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","fromBlock","toBlock","options","contract","from","to","effectiveFrom","_yield$ethereumLedger","events","lastSynced","txns","wrap","_context","prev","next","getAnchorContract","sent","isNumber","ethereumLedgerUtils","getBlock","number","Math","max","lastSyncedBlockchainTime","log","SOVRA_PREFIX","getPastEventsChunked","filter","length","map","eventLogToSidetreeTransaction","omitTimestamp","abrupt","extendSidetreeTransactionWithTimestamp","stop","_x","_x2","_x3","apply","arguments","_ref2","_callee2","anchorString","_fee","_this$getWriteData","numberOfOperations","buffer","methodCall","currentGasPrice","gas","gasPrice","txn","txUrl","_context2","getWriteData","methods","anchorHash","toString","substring","eth","getGasPrice","estimateGas","round","parseInt","send","explorerBaseUrl","transactionHash","info","t0","error","message","_x4","_x5","startingTime","_proto","prototype","getServiceVersion","Promise","resolve","name","initialize","_initialize","_callee3","_context3","this","getLatestTime","time","networkId","n","isNaN","parseFloat","_getTransactionsSince","_getTransactionsSince2","_callee4","since","_context4","_getTransactions","x","transactionNumber","_x6","_x7","_x8","_x9","read","_read","_callee5","sinceTransactionNumber","transactionTimeHash","transactions","block","_context5","undefined","moreTransactions","_x10","_x11","setExplorerUrl","url","key","get","cachedBlockchainTime","EthereumLedger"],"mappings":"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"}